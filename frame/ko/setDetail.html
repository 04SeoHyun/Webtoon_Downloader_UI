<!DOCTYPE html>
<html lang="ko">
<body>
<div class="section">
    <div style="width:calc(80vw - 4px);margin-left: 50vw;transform: translateX(-50%);">
        <div style="width:100%;height:174px;">
            <div style="float: left; width: 250px;height:174px;">
                <div id="cover" style="height: 100px;">
                    <div id="thumbnail" style="margin:0;padding-bottom:0;bottom:0;height: 100%;"></div>
                </div>
            </div>
            <div style="float: left;min-width:100px;width:calc(100% - 250px);padding-left: 30px;min-height: 174px;display: flex;align-items: center;justify-content: center;">
                <div>
                    <h3 id="webToonTitle" style="font-size: 30px;"></h3>
                    <p id="webToonText" style="font-size: 20px;"></p>
                </div>
            </div>
        </div>
        <div id="basicDetail" style="width:100%;transition: all ease-in-out .5s;">
            <br>
            <h2 style="font-size: 30px;margin: 10px 10px 45px;">다운받을 회차</h2>
            <div id="range" style="margin: 15px;"></div>
            <h2 style="font-size: 30px;margin: 20px 10px 10px;">저장할 경로</h2>
            <form class="form__group" id="comicName" onkeydown="return event.key != 'Enter';" style="padding:10px;">
                <input class="form__field" id="saveDir" name="fname"
                       onclick="selectFolder();" placeholder="경로" readonly type="text">
                <label class="form__label" for="saveDir">경로</label>
            </form>
            <div>
                <div class="btn" onclick="openSaveOpSection();" style="width:80px;float: right;">다음</div>
            </div>
        </div>
        <div id="secondDetail"
             style="width:100%;margin-left:30px;opacity:0;display:none;transition: all ease-in-out .5s;">
            <br>
            <h2 style="font-size: 30px;margin: 10px 10px 45px;">다운로드 속도</h2>
            <div id="speed" style="margin: 15px;"></div>
            <h2 style="font-size: 30px;margin: 20px 10px 10px;">다운로드 옵션</h2>
            <div>
                <div class="btn" onclick="download();" style="width:80px;float: right;">다운로드</div>
            </div>
        </div>
        <div id="downloadDetail"
             style="width:100%;margin-left:30px;opacity:0;display:none;transition: all ease-in-out .5s;">
            <br>
            <h2 style="font-size: 30px;margin: 10px 10px 45px;">다운로드 중...</h2>
        </div>
    </div>
</div>
<script>
    function download() {
        document.getElementById('secondDetail').style.marginLeft = '-30px';
        document.getElementById('secondDetail').style.opacity = '0';
        setTimeout(() => {
            document.getElementById('secondDetail').style.display = 'none';
            document.getElementById('downloadDetail').style.display = 'block';
            setTimeout(() => {
                document.getElementById('downloadDetail').style.marginLeft = '0';
                document.getElementById('downloadDetail').style.opacity = '1';
            }, 100);
        }, 500);
    }

    function openSaveOpSection() {
        document.getElementById('basicDetail').style.marginLeft = '-30px';
        document.getElementById('basicDetail').style.opacity = '0';
        setTimeout(() => {
            document.getElementById('basicDetail').style.display = 'none';
            document.getElementById('secondDetail').style.display = 'block';
            setTimeout(() => {
                document.getElementById('secondDetail').style.marginLeft = '0';
                document.getElementById('secondDetail').style.opacity = '1';
            }, 100);
        }, 500);
    }

    function selectFolder() {
        dialog.showOpenDialog({
            properties: ['openDirectory']
        }).then(result => {
            document.getElementById('saveDir').value = path.join(result.filePaths[0], webtoonTitle);
        });
    }

    function getQueryStringObject(ur) {
        var a = ur.split('?')[1].split('&');
        if (a == "") return {};
        var b = {};
        for (var i = 0; i < a.length; ++i) {
            var p = a[i].split('=', 2);
            if (p.length == 1) b[p[0]] = "";
            else b[p[0]] = decodeURIComponent(p[1].replace(/\+/g, " "));
        }
        return b;
    }

    function naverDetail() {
        showToast("정보를 불러오는 중...", '');
        fetch("https://comic.naver.com/webtoon/list.nhn?titleId=" + webtoonId).then(response => {
            response.text().then(result => {
                const cheerio = require('cheerio');
                const H = cheerio.load(result);
                webtoonTitle = H('meta[property="og:title"]').attr("content")
                let helper = H('div .detail > p').html()
                //document.getElementById('thumbnail').src = imgurl;
                document.getElementById('webToonTitle').innerHTML = webtoonTitle;
                document.getElementById('webToonText').innerHTML = helper;
                fetch("https://comic.naver.com/webtoon/detail.nhn?titleId=" + webtoonId + "&no=0").then(response => {
                    response.text().then(result2 => {
                        const H2 = cheerio.load(result2)
                        ur = H2('meta[property="og:url"]').attr("content")
                        if (ur == "https://comic.naver.com/main.nhn") {
                            showToast("웹툰 ID가 올바르지 않아요!");
                            return;
                        }
                        if (ur == null) {
                            showToast("계속하려면 네이버 아이디로 로그인해야합니다.");
                            return;
                        }
                        let maxEpisode = parseInt(getQueryStringObject(ur)['no']);
                        document.getElementById('cover').style.background = '#ffffff';
                        let range = document.getElementById('range');
                        let speed = document.getElementById('speed');

                        noUiSlider.create(range, {
                            start: [1, maxEpisode],
                            connect: true,
                            step: 1,
                            range: {
                                'min': 1,
                                'max': maxEpisode
                            },
                            tooltips: [wNumb({decimals: 0}), wNumb({decimals: 0})]
                        });

                        noUiSlider.create(speed, {
                            start: [4],
                            step: 1,
                            range: {
                                'min': 1,
                                'max': 5
                            },
                            tooltips: {
                                from: Number,
                                to: (num) => {
                                    if (num == 1) return "매우 느리게";
                                    if (num == 2) return "느리게";
                                    if (num == 3) return "보통";
                                    if (num == 4) return "빠르게";
                                    if (num == 5) return "매우 빠르게";
                                }
                            }
                        });
                        closeToast();
                    });
                });
            });
        });
        fetch('https://m.comic.naver.com/webtoon/list.nhn?titleId=' + webtoonId)
            .then(response => {
                response.text().then(res => {
                    newEls = [];
                    const parser = new DOMParser();
                    try {
                        maxPage = parseInt(parser.parseFromString(res, 'text/html').querySelector('.total').innerText.replace(/[^\d.]/g, ''));
                    } catch (e) {
                        maxPage = 1;
                    }
                    try {
                        parser.parseFromString(res, 'text/html').querySelector('.area_thumbnail').childNodes.forEach(el => {
                            if (el.nodeName == "IMG") {
                                let newEl = document.createElement('img');
                                newEl.innerHTML = el.innerHTML;
                                newEl.src = el.src;
                                newEl.classList.add('thumbnailImg');
                                newEls.push(newEl);
                            }
                        });
                    } catch (e) {

                    }
                    newEls.reverse();
                    try {
                        parser.parseFromString(res, 'text/html').querySelector('.thumb_bg').childNodes.forEach(el => {
                            if (el.nodeName == "IMG") {
                                let newEl = document.createElement('img');
                                newEl.innerHTML = el.innerHTML;
                                newEl.src = el.src;
                                newEl.classList.add('thumbnailBGImg');
                                newEls.push(newEl);
                            }
                        });
                    } catch (e) {

                    }
                    newEls.reverse();
                    newEls.forEach(el => {
                        document.getElementById('thumbnail').appendChild(el);
                    })
                });
            });
    }

    function setDetail_init() {
        naverDetail();
    }
</script>
</body>
</html>